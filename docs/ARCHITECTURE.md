# ğŸ—ï¸ ArhitecturÄƒ OS-RISCV

## ğŸ“Š DiagramÄƒ ArhitecturalÄƒ - Straturi

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER SPACE                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   user1      â”‚              â”‚   user2      â”‚            â”‚
â”‚  â”‚  (PID 1)     â”‚              â”‚  (PID 2)     â”‚            â”‚
â”‚  â”‚              â”‚              â”‚              â”‚            â”‚
â”‚  â”‚ - Loops      â”‚              â”‚ - Loops      â”‚            â”‚
â”‚  â”‚ - Syscalls   â”‚              â”‚ - Syscalls   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                              â”‚                    â”‚
â”‚         â”‚ ecall                        â”‚ ecall              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚
          â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SYSCALL INTERFACE                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SYS_WRITE (64)   â”‚ SYS_YIELD (124) â”‚ SYS_GETTIME   â”‚  â”‚
â”‚  â”‚                   â”‚                  â”‚ (169)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚
          â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KERNEL SPACE                              â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              PROCESS MANAGEMENT                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Scheduler     â”‚  â”‚  Process Table           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Round-robin â”‚  â”‚  - 10 slots (PROC_MAX)   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Preemptive  â”‚  â”‚  - PID, state, context   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Fair        â”‚  â”‚  - Stack 4KB per proc    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Context Switch (comutare.S)                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Saves: ra, sp, s0-s11                       â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              MEMORY MANAGEMENT                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Heap Allocator                                 â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - List-based free blocks                       â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - First-fit allocation                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Coalescing on free                           â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - kmalloc() / kfree()                          â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Program Loader (RAMFS)                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - user1.bin â†’ 0x80400000                       â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - user2.bin â†’ 0x80500000                       â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              INTERRUPT HANDLING                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Timer (CLINT) â”‚  â”‚  Trap Handler (start.S)  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - 100Hz       â”‚  â”‚  - Saves all registers   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Preemption  â”‚  â”‚  - Calls handler_c()     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - CPU time    â”‚  â”‚  - Restores context      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              DEVICE DRIVERS                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  UART Driver (16550)                            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - uart_putchar() / uart_getchar()              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Non-blocking I/O                             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Base: 0x10000000                             â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              SHELL INTERFACE                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Interactive Shell                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - help, ps, uptime, mem, kill, exec            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Command parsing                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Process control                              â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚
          â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HARDWARE LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   CLINT     â”‚  â”‚    UART     â”‚  â”‚   Memory         â”‚   â”‚
â”‚  â”‚ 0x02000000  â”‚  â”‚ 0x10000000  â”‚  â”‚  - Kernel heap   â”‚   â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚  - User stacks   â”‚   â”‚
â”‚  â”‚ - mtime     â”‚  â”‚ - TX/RX     â”‚  â”‚  - Program code  â”‚   â”‚
â”‚  â”‚ - mtimecmp  â”‚  â”‚ - Status    â”‚  â”‚                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚              RISC-V RV32IMA (QEMU virt machine)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow - Exemple

### 1. Syscall Write (user â†’ kernel â†’ device)
```
user1 process
  â”‚
  â”œâ”€ sys_write(1, "Hello", 5)
  â”‚
  â–¼
ecall instruction
  â”‚
  â–¼
Trap Handler (start.S)
  â”‚ - SalveazÄƒ registre
  â”‚ - IdentificÄƒ mcause = 0x0B (ecall)
  â”‚
  â–¼
handler_c()
  â”‚
  â”œâ”€ syscall_handler()
  â”‚   â”‚
  â”‚   â”œâ”€ a7 = 64 (SYS_WRITE)
  â”‚   â”‚
  â”‚   â””â”€ sys_write(a0=fd, a1=buf, a2=len)
  â”‚       â”‚
  â”‚       â””â”€ uart_putstring(buf)
  â”‚           â”‚
  â”‚           â””â”€ uart_putchar() Ã— 5
  â”‚               â”‚
  â”‚               â–¼
  â”‚         UART Hardware (0x10000000)
  â”‚               â”‚
  â”‚               â–¼
  â”‚         Console output: "Hello"
  â”‚
  â–¼
Return to user (mret)
```

### 2. Timer Preemption (hardware â†’ kernel â†’ scheduler)
```
CLINT Timer (100Hz)
  â”‚
  â”œâ”€ mtime >= mtimecmp
  â”‚
  â–¼
Timer Interrupt (mcause = 0x80000007)
  â”‚
  â–¼
Trap Handler
  â”‚ - SalveazÄƒ registre
  â”‚
  â–¼
handler_c()
  â”‚
  â”œâ”€ tick()
  â”‚   â”œâ”€ counter_tick++
  â”‚   â”œâ”€ proc_table[proc_actual].cpu_time++
  â”‚   â”œâ”€ Display uptime (every 1000 ticks)
  â”‚   â”‚
  â”‚   â””â”€ preempt()  â† TRUE PREEMPTIVE!
  â”‚       â”‚
  â”‚       â”œâ”€ proc_table[proc_actual].state = READY
  â”‚       â”‚
  â”‚       â””â”€ comutare(current, idle)
  â”‚           â”‚ - SalveazÄƒ context (ra, sp, s0-s11)
  â”‚           â”‚ - Switch stack
  â”‚           â”‚ - RestaureazÄƒ context idle
  â”‚           â”‚
  â”‚           â–¼
  â”‚       Scheduler (PID 0)
  â”‚           â”‚
  â”‚           â”œâ”€ find_next_ready() â†’ round-robin
  â”‚           â”‚
  â”‚           â””â”€ comutare(idle, next_process)
  â”‚               â”‚
  â”‚               â–¼
  â”‚           Next Process resumes
  â”‚
  â–¼
Process continues execution
```

### 3. Process Creation (shell â†’ kernel â†’ loader â†’ scheduler)
```
Shell command: "exec user1"
  â”‚
  â–¼
cmd_exec("user1")
  â”‚
  â”œâ”€ ramfs_find("user1") â†’ binary data
  â”‚
  â”œâ”€ Allocate memory: 0x80400000
  â”‚
  â”œâ”€ Copy binary to memory
  â”‚
  â”œâ”€ create_process(entry=0x80400000, stack=...)
  â”‚   â”‚
  â”‚   â”œâ”€ Find free slot in proc_table
  â”‚   â”‚
  â”‚   â”œâ”€ Initialize:
  â”‚   â”‚   - state = READY
  â”‚   â”‚   - pid = 1
  â”‚   â”‚   - context.sp = stack_top
  â”‚   â”‚   - context.ra = 0x80400000
  â”‚   â”‚
  â”‚   â””â”€ Return PID
  â”‚
  â–¼
Scheduler picks up process on next cycle
  â”‚
  â””â”€ Process starts executing at 0x80400000
```

---

## ğŸ“ Structura FiÈ™iere

```
OS-RISCV/
â”œâ”€â”€ headere/              # Header files
â”‚   â”œâ”€â”€ csr.h            # CSR definitions (mstatus, mie, etc.)
â”‚   â”œâ”€â”€ mm.h             # Memory management interface
â”‚   â”œâ”€â”€ proc.h           # Process management interface
â”‚   â”œâ”€â”€ syscall.h        # Syscall numbers
â”‚   â””â”€â”€ kernel_lib.h     # Kernel utilities
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ boot/
â”‚   â”‚   â””â”€â”€ start.S      # Boot code + Trap handler (assembly)
â”‚   â”‚
â”‚   â”œâ”€â”€ kernel/
â”‚   â”‚   â”œâ”€â”€ main.c       # kmain() - kernel entry point
â”‚   â”‚   â”œâ”€â”€ mm.c         # Heap allocator (kmalloc/kfree)
â”‚   â”‚   â”œâ”€â”€ proc.c       # Scheduler + process management
â”‚   â”‚   â”œâ”€â”€ comutare.S   # Context switch (assembly)
â”‚   â”‚   â”œâ”€â”€ timer.c      # Timer + preemption
â”‚   â”‚   â”œâ”€â”€ interrupt.c  # Interrupt dispatcher
â”‚   â”‚   â”œâ”€â”€ syscall.c    # Syscall handlers
â”‚   â”‚   â”œâ”€â”€ uart.c       # UART driver
â”‚   â”‚   â”œâ”€â”€ loader.c     # RAMFS + program loader
â”‚   â”‚   â””â”€â”€ shell.c      # Interactive shell
â”‚   â”‚
â”‚   â””â”€â”€ kernel_lib/
â”‚       â””â”€â”€ kernel_lib.c # String utilities
â”‚
â”œâ”€â”€ user/
â”‚   â”œâ”€â”€ user1.c          # User program 1
â”‚   â””â”€â”€ user2.c          # User program 2
â”‚
â”œâ”€â”€ script/
â”‚   â”œâ”€â”€ kernel.ld        # Kernel linker script
â”‚   â”œâ”€â”€ user.ld          # User program 1 linker
â”‚   â””â”€â”€ user2.ld         # User program 2 linker
â”‚
â””â”€â”€ Makefile             # Build system
```

---

## ğŸ¯ Componente Principale

### Process Management (proc.c/h)
- **Scheduler**: Round-robin preemptive, 100Hz time slice
- **Process table**: 10 slots, tracking PID, state, context, CPU time
- **Context switch**: Assembly routine pentru salvare/restaurare registre

### Memory Management (mm.c/h)
- **Heap allocator**: First-fit cu coalescing
- **Free list**: Linked list de blocuri libere
- **Functions**: kmalloc(), kfree(), mm_stats()

### Timer & Interrupts (timer.c, interrupt.c)
- **CLINT timer**: 100Hz tick rate
- **Preemption**: ForÈ›atÄƒ la fiecare tick pentru procese user
- **CPU time tracking**: Per-process accounting

### Device Drivers (uart.c, loader.c)
- **UART 16550**: Serial I/O pentru console
- **RAMFS**: Simple in-memory filesystem pentru user programs

### System Calls (syscall.c/h)
- **SYS_WRITE (64)**: Output to console
- **SYS_YIELD (124)**: Voluntary yield (opÈ›ional cu preemption)
- **SYS_GETTIME (169)**: Get tick counter

### Shell (shell.c)
- **Commands**: help, ps, uptime, mem, kill, exec
- **Interactive**: Non-blocking input polling
- **Process control**: Launch È™i terminate procese

---

## ğŸ”§ Detalii Tehnice

### Address Space Layout
```
0x80000000  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Kernel Code    â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  Kernel Data    â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  Kernel BSS     â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  Kernel Heap    â”‚  â† kmalloc/kfree
            â”‚  (dynamic)      â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
0x80400000  â”‚  User1 Code     â”‚  â† Loaded by exec
            â”‚  (4KB)          â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
0x80500000  â”‚  User2 Code     â”‚  â† Loaded by exec
            â”‚  (4KB)          â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  Process Stacks â”‚  â† In proc_table
            â”‚  (4KB each)     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Registre RISC-V Usage
- **a0-a7**: Syscall arguments/return values
- **t0-t6**: Temporary (caller-saved)
- **s0-s11**: Saved registers (callee-saved) - Ã®n context
- **ra**: Return address - Ã®n context
- **sp**: Stack pointer - Ã®n context

### Timer Configuration
- **CLINT Base**: 0x02000000
- **mtime**: Current time counter
- **mtimecmp**: Compare value for interrupt
- **Frequency**: ~10MHz â†’ 100Hz interrupts (TIMER_INTERVAL=100000)

---

## ğŸš€ Boot & Execution Flow

Vezi [BOOT_FLOW.md](BOOT_FLOW.md) pentru detalii complete despre secvenÈ›a de boot.

Vezi [TRUE_PREEMPTIVE_IMPLEMENTATION.md](TRUE_PREEMPTIVE_IMPLEMENTATION.md) pentru detalii despre scheduler.
